<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Modifier les menus</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 2rem auto;
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 2rem;
    }
    h1 {
      text-align: center;
      color: #8B0000;
    }
    .menu-section {
      margin-bottom: 2.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 2rem;
    }
    .menu-section:last-child {
      border-bottom: none;
    }
    h2 {
      color: #2E2E2E;
      margin-top: 0;
    }
    h3 {
      color: #8B0000;
      margin-bottom: 0.7em;
      margin-top: 1.5em;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      border-bottom: 2px solid #8B0000;
      display: inline-block;
      padding-bottom: 0.15em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #f5f5f5;
    }
    input[type="text"], input[type="number"] {
      width: 90%;
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
    }
    .actions {
      display: flex;
      gap: 0.5rem;
    }
    button {
      background: #8B0000;
      color: #fff;
      border: none;
      border-radius: 0.25rem;
      padding: 0.4rem 1rem;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    button:hover {
      background: #a83232;
    }
    .add-btn {
      background: #2E2E2E;
      margin-top: 0.1rem;
      margin-bottom: 0.7rem;
      margin-left: 0;
      display: block;
      text-align: left;
    }
    .add-btn:hover {
      background: #444;
    }
    .success, .error {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: bold;
    }
    .success { color: #2e7d32; }
    .error { color: #b71c1c; }
    .vin-moment-section {
      margin-top: 2.5rem;
      padding-top: 2rem;
      border-top: 2px solid #eee;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      color: #2E2E2E;
    }
    #vinMomentInput {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Panel Admin</h1>
    <button id="exportMenusBtn" style="margin-bottom:1.5rem;float:right;background:#2E2E2E;">Exporter menus.json</button>
    <div id="toast" style="position:fixed;right:2rem;bottom:2rem;z-index:1000;min-width:200px;max-width:350px;padding:1rem 1.5rem;border-radius:0.5rem;background:#2e7d32;color:#fff;font-size:1.1rem;box-shadow:0 2px 8px rgba(0,0,0,0.15);display:none;align-items:center;gap:0.5rem;"></div>
    <form id="menusForm">
      <div class="menu-section" data-section="midi">
        <h2>Menu du midi</h2>
        <table>
          <thead><tr><th>Label</th><th>Prix (€)</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <button type="button" class="add-btn">Ajouter un plat</button>
      </div>
      <div class="menu-section" data-section="boissons">
        <h2>Boissons</h2>
        <h3>Bières</h3>
        <table data-subsection="bieres">
          <thead><tr><th>Label</th><th>Prix (€)</th><th>Description</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <button type="button" class="add-btn" data-subsection="bieres">Ajouter une bière</button>
        <h3>Softs</h3>
        <table data-subsection="softs">
          <thead><tr><th>Label</th><th>Prix (€)</th><th>Description</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <button type="button" class="add-btn" data-subsection="softs">Ajouter un soft</button>
      </div>
      <div class="menu-section" data-section="cocktails">
        <h2>Cocktails</h2>
        <h3>Cocktails</h3>
        <table data-subsection="cocktails">
          <thead><tr><th>Label</th><th>Prix (€)</th><th>Description</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <button type="button" class="add-btn" data-subsection="cocktails">Ajouter un cocktail</button>
        <h3>Mocktails</h3>
        <table data-subsection="mocktails">
          <thead><tr><th>Label</th><th>Prix (€)</th><th>Description</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <button type="button" class="add-btn" data-subsection="mocktails">Ajouter un mocktail</button>
      </div>
      <div class="vin-moment-section">
        <label for="vinMomentInput">Phrase à afficher pour le vin du moment :</label>
        <input type="text" id="vinMomentInput" required />
      </div>
    </form>
  </div>
  <script>
    // Utilitaires DOM
    function createRow(item = {label:'', prix:'', description:''}, removable = true, sectionName = '', isNew = false) {
      const tr = document.createElement('tr');
      const isEmpty = !item.label && !item.prix && !item.description;
      if(sectionName === 'cocktails' || sectionName === 'bieres' || sectionName === 'softs' || sectionName === 'mocktails') {
        tr.innerHTML = `
          <td><input type="text" value="${item.label || ''}" required></td>
          <td><input type="number" min="0" step="0.01" value="${(item.prix !== undefined && item.prix !== null && item.prix !== '') ? Number(item.prix).toFixed(2) : ''}" required></td>
          <td><input type="text" value="${item.description || ''}" placeholder="Description" /></td>
          <td class="actions"></td>
        `;
      } else {
        tr.innerHTML = `
          <td><input type="text" value="${item.label || ''}" required></td>
          <td><input type="number" min="0" step="0.01" value="${(item.prix !== undefined && item.prix !== null && item.prix !== '') ? Number(item.prix).toFixed(2) : ''}" required></td>
          <td class="actions"></td>
        `;
      }
      const actionsTd = tr.querySelector('.actions');
      const makeValiderBtn = () => {
        actionsTd.innerHTML = '';
        const validerBtn = document.createElement('button');
        validerBtn.type = 'button';
        validerBtn.textContent = 'Valider';
        validerBtn.style.background = '#2e7d32';
        validerBtn.onclick = () => {
          const inputs = tr.querySelectorAll('input');
          const label = inputs[0].value.trim();
          const prix = inputs[1].value;
          if(!label || !prix) {
            alert('Le label et le prix sont obligatoires.');
            return;
          }
          // Remplace le bouton par Supprimer
          makeSupprimerBtn();
          // Sauvegarde automatique
          document.getElementById('menusForm').dispatchEvent(new Event('submit', { cancelable: true }));
        };
        actionsTd.appendChild(validerBtn);
      };
      const makeSupprimerBtn = () => {
        actionsTd.innerHTML = '';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.textContent = 'Supprimer';
        delBtn.onclick = () => {
          if(confirm('Voulez-vous vraiment supprimer cet élément ?')) {
            tr.remove();
            document.getElementById('menusForm').dispatchEvent(new Event('submit', { cancelable: true }));
          }
        };
        actionsTd.appendChild(delBtn);
      };
      if(removable) {
        if(isNew || isEmpty) {
          makeValiderBtn();
        } else {
          makeSupprimerBtn();
        }
      }
      // Ajoute le comportement d'édition : si on modifie un input, bouton Valider
      tr.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => {
          if(actionsTd.querySelector('button')?.textContent !== 'Valider') {
            makeValiderBtn();
          }
        });
      });
      return tr;
    }

    // Remplit les tableaux avec les données
    function fillSection(section, items, subsection) {
      const tbody = subsection ? section.querySelector(`table[data-subsection="${subsection}"] tbody`) : section.querySelector('tbody');
      tbody.innerHTML = '';
      const sectionName = section.dataset.section;
      items.forEach(item => {
        tbody.appendChild(createRow(item, true, subsection || sectionName));
      });
    }

    // Charge les menus existants
    fetch('/api/menus')
      .then(res => res.json())
      .then(data => {
        document.querySelectorAll('.menu-section').forEach(section => {
          const name = section.dataset.section;
          if(name === 'boissons') {
            fillSection(section, data.boissons.bieres, 'bieres');
            fillSection(section, data.boissons.softs, 'softs');
          } else if(name === 'cocktails') {
            fillSection(section, data.cocktails.cocktails, 'cocktails');
            fillSection(section, data.cocktails.mocktails, 'mocktails');
          } else if(name === 'vin') {
            document.getElementById('vinInput').value = data.vin || '';
          } else {
            fillSection(section, data[name] || []);
          }
        });
        // Phrase vin du moment
        document.getElementById('vinMomentInput').value = data.vin_moment || '';
      });

    // Ajout d'un nouvel item
    document.querySelectorAll('.add-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const section = btn.closest('.menu-section');
        const subsection = btn.dataset.subsection;
        if(subsection) {
          const table = section.querySelector(`table[data-subsection="${subsection}"]`);
          table.querySelector('tbody').appendChild(createRow({}, true, subsection, true));
        } else {
          section.querySelector('tbody').appendChild(createRow({}, true, section.dataset.section, true));
        }
        // Pas de sauvegarde auto ici, on attend la validation
      });
    });

    // Sauvegarde des modifications
    document.getElementById('menusForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      let hasError = false;
      for(const section of document.querySelectorAll('.menu-section')) {
        const name = section.dataset.section;
        if(name === 'boissons') {
          // Bières
          const bieres = Array.from(section.querySelector('table[data-subsection="bieres"] tbody').querySelectorAll('tr')).map(tr => {
            const inputs = tr.querySelectorAll('input');
            return { label: inputs[0].value.trim(), prix: Number(inputs[1].value), description: inputs[2].value.trim() };
          }).filter(item => item.label && !isNaN(item.prix));
          // Softs
          const softs = Array.from(section.querySelector('table[data-subsection="softs"] tbody').querySelectorAll('tr')).map(tr => {
            const inputs = tr.querySelectorAll('input');
            return { label: inputs[0].value.trim(), prix: Number(inputs[1].value), description: inputs[2].value.trim() };
          }).filter(item => item.label && !isNaN(item.prix));
          try {
            const res = await fetch(`/api/menus/boissons`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ bieres, softs })
            });
            if(!res.ok) throw new Error();
          } catch {
            hasError = true;
          }
        } else if(name === 'cocktails') {
          // Cocktails
          const cocktails = Array.from(section.querySelector('table[data-subsection="cocktails"] tbody').querySelectorAll('tr')).map(tr => {
            const inputs = tr.querySelectorAll('input');
            return { label: inputs[0].value.trim(), prix: Number(inputs[1].value), description: inputs[2].value.trim() };
          }).filter(item => item.label && !isNaN(item.prix));
          // Mocktails
          const mocktails = Array.from(section.querySelector('table[data-subsection="mocktails"] tbody').querySelectorAll('tr')).map(tr => {
            const inputs = tr.querySelectorAll('input');
            return { label: inputs[0].value.trim(), prix: Number(inputs[1].value), description: inputs[2].value.trim() };
          }).filter(item => item.label && !isNaN(item.prix));
          try {
            const res = await fetch(`/api/menus/cocktails`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ cocktails, mocktails })
            });
            if(!res.ok) throw new Error();
          } catch {
            hasError = true;
          }
        } else if(name === 'vin') {
          // (non utilisé)
        } else {
          const items = Array.from(section.querySelectorAll('tbody tr')).map(tr => {
            const inputs = tr.querySelectorAll('input');
            if(name === 'cocktails') {
              return {
                label: inputs[0].value.trim(),
                prix: Number(inputs[1].value),
                description: inputs[2].value.trim()
              };
            } else {
              return {
                label: inputs[0].value.trim(),
                prix: Number(inputs[1].value)
              };
            }
          }).filter(item => item.label && !isNaN(item.prix));
          try {
            const res = await fetch(`/api/menus/${name}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(items)
            });
            if(!res.ok) throw new Error();
          } catch {
            hasError = true;
          }
        }
      }
      // Phrase vin du moment
      const phrase = document.getElementById('vinMomentInput').value.trim();
      try {
        const res = await fetch(`/api/menus/vin_moment`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vin_moment: phrase })
        });
        if(!res.ok) throw new Error();
      } catch {
        hasError = true;
      }
      if(hasError) {
        showToast('Erreur lors de la sauvegarde.', false);
      } else {
        showToast('Modifications enregistrées !', true);
      }
    });

    // Bouton export menus.json
    document.addEventListener('DOMContentLoaded', () => {
      const exportBtn = document.getElementById('exportMenusBtn');
      if(exportBtn) {
        exportBtn.addEventListener('click', async () => {
          try {
            const res = await fetch('/api/menus');
            if(!res.ok) throw new Error('Erreur API');
            const data = await res.json();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'menus.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch {
            alert('Erreur lors de l\'export.');
          }
        });
      }
    });

    // Fonction pour afficher un toast
    function showToast(msg, success = true) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.background = success ? '#2e7d32' : '#b71c1c';
      toast.style.display = 'flex';
      setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }
  </script>
</body>
</html> 